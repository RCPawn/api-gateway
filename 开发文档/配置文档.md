# ğŸ—ï¸ å¾®æœåŠ¡ç½‘å…³é¡¹ç›®è¿›åº¦æ±‡æ€» 

**æ›´æ–°æ—¶é—´**: 2026-01-02
**å½“å‰é˜¶æ®µ**: ç¬¬ä¸‰é˜¶æ®µï¼ˆå®‰å…¨æ¶æ„å‡çº§ï¼‰è¿›è¡Œä¸­

## 1. æ ¸å¿ƒæ¶æ„ä¸æŠ€æœ¯æ ˆ
*   **JDK**: 17
*   **æ¡†æ¶**: Spring Boot 3.2.x, Spring Cloud 2023.x, Spring Cloud Alibaba 2023.x
*   **æ³¨å†Œ/é…ç½®ä¸­å¿ƒ**: Nacos 2.x (Port: 8848)
*   **ç½‘å…³**: Spring Cloud Gateway (Port: 9000, WebFlux)
*   **æµé‡é˜²æŠ¤**: Sentinel 1.8.x (Port: 8090, è§„åˆ™æŒä¹…åŒ–è‡³ Nacos)
*   **é“¾è·¯è¿½è¸ª**: Apache SkyWalking 10.x (OAP: 11800/12800, UI: 8088, Agent: 9.3.0)
*   **é€šä¿¡åè®®**: OpenFeign (å†…éƒ¨è°ƒç”¨)
*   **å®‰å…¨é‰´æƒ**: JWT + ThreadLocal

## 2. å·¥ç¨‹ç»“æ„
é¡¹ç›®å·²é‡æ„ä¸ºèšåˆå·¥ç¨‹ `spring-cloud-demo`ï¼ŒåŒ…å«ä»¥ä¸‹æ¨¡å—ï¼š

| æ¨¡å—åç§°             | ç«¯å£      | è§’è‰²ä¸åŠŸèƒ½                                                   |
| :------------------- | :-------- | :----------------------------------------------------------- |
| **api-gateway**      | 9000      | **ç½‘å…³å…¥å£**ã€‚è´Ÿè´£è·¯ç”±è½¬å‘ã€å…¨å±€é‰´æƒ(Filter)ã€é™æµ(Sentinel)ã€‚ |
| **service-consumer** | 8083      | **æ¶ˆè´¹è€…(ä¸šåŠ¡èšåˆ)**ã€‚é›†æˆ Feign è°ƒç”¨ Providerï¼ŒåŒ…å«ç™»å½•æ¥å£ã€‚ |
| **service-provider** | 8081/8082 | **æä¾›è€…(åº•å±‚æœåŠ¡)**ã€‚æä¾›åŸºç¡€ä¸šåŠ¡æ¥å£ï¼Œéƒ¨ç½²äº†åŒå®ä¾‹(é›†ç¾¤)ã€‚ |
| **service-common**   | N/A       | **é€šç”¨å·¥å…·åŒ…**ã€‚å« `JwtUtil`ã€`UserContext`ã€æ‹¦æˆªå™¨ç­‰ï¼Œè¢«å…¶ä»–æ¨¡å—å¼•ç”¨ã€‚ |

## 3. å·²å®ç°åŠŸèƒ½é‡Œç¨‹ç¢‘

### 3.1 åŸºç¡€è®¾æ–½ä¸è·¯ç”± (Phase 1)
*   [x] **Nacos æ³¨å†Œå‘ç°**ï¼šæ‰€æœ‰æœåŠ¡å‡æ³¨å†Œè‡³ Nacosã€‚
*   [x] **åŠ¨æ€è·¯ç”±æ¶æ„**ï¼š
    *   å®ç° Nacos ç›‘å¬å™¨ (`DynamicRouteLoader`)ã€‚
    *   æ”¯æŒ Nacos JSON é…ç½®çƒ­æ›´æ–°è·¯ç”±ï¼Œ**é›¶åœæœº**ä¿®æ”¹è½¬å‘è§„åˆ™ã€‚
    *   æ”¯æŒ `StripPrefix` (å»å‰ç¼€) ä¸ä¿ç•™å‰ç¼€ä¸¤ç§è½¬å‘æ¨¡å¼ã€‚
*   [x] **è´Ÿè½½å‡è¡¡**ï¼šGateway è½¬å‘ä¸ Feign è°ƒç”¨å‡å®ç°äº† LoadBalancer (è½®è¯¢)ã€‚

### 3.2 å…¨é“¾è·¯å¯è§‚æµ‹æ€§ (Phase 2)
*   [x] **SkyWalking ç›‘æ§**ï¼š
    *   å…¨æœåŠ¡æŒ‚è½½ Java Agentã€‚
    *   è§£å†³ Gateway (WebFlux) æ’ä»¶å…¼å®¹æ€§é—®é¢˜ (æ‰‹åŠ¨æ¬è¿ `optional-plugins`)ã€‚
    *   å®ç°å®Œæ•´çš„æ‹“æ‰‘å›¾ç»˜åˆ¶ (`User` -> `Gateway` -> `Consumer` -> `Provider`)ã€‚
*   [x] **Sentinel æµé‡é˜²æŠ¤**ï¼š
    *   **ç½‘å…³æµæ§**ï¼šåœ¨ Sentinel æ§åˆ¶å°å¯ç”¨â€œç½‘å…³æµæ§è§„åˆ™â€èœå•ã€‚
    *   **è§„åˆ™æŒä¹…åŒ–**ï¼šæµæ§è§„åˆ™å­˜å‚¨äº Nacos (`gateway-sentinel-rule.json`)ï¼Œé‡å¯ä¸ä¸¢å¤±ã€‚
    *   **è·¯ç”±çº§é™æµ**ï¼šé’ˆå¯¹ Route ID (`route_to_provider`, `route_to_consumer`) ç‹¬ç«‹è®¾ç½® QPS é˜ˆå€¼ã€‚

### 3.3 å®‰å…¨ä¸é‰´æƒä½“ç³» (Phase 3 - Current)
*   [x] **Maven æ¶æ„é‡æ„**ï¼šå®Œæˆå¤šæ¨¡å—æ‹†åˆ†ï¼Œç»Ÿä¸€çˆ¶å·¥ç¨‹ç‰ˆæœ¬ç®¡ç†ã€‚
*   [x] **JWT æ ¸å¿ƒèƒ½åŠ›**ï¼š
    *   `service-common` å°è£… JWT ç”Ÿæˆä¸è§£æå·¥å…·ã€‚
    *   å®ç° `/auth/login` æ¥å£ï¼ˆä½äº Consumerï¼‰ï¼ŒéªŒè¯è´¦å·å¯†ç å¹¶ä¸‹å‘ Tokenã€‚
*   [x] **ç½‘å…³å…¨å±€å®ˆå«**ï¼š
    *   å®ç° `AuthGlobalFilter`ã€‚
    *   æ ¡éªŒè¯·æ±‚å¤´/å‚æ•°ä¸­çš„ Tokenï¼Œéæ³•è¯·æ±‚ç›´æ¥è¿”å› 401 JSONã€‚
    *   **èº«ä»½é€ä¼ **ï¼šè§£æ Token å¾—åˆ° UserIDï¼Œå†™å…¥ Request Header (`X-User-Id`) ä¼ ç»™ä¸‹æ¸¸ã€‚
*   [x] **æœåŠ¡å†…éƒ¨ä¸Šä¸‹æ–‡**ï¼š
    *   å®ç° `UserInfoInterceptor` (Spring MVC æ‹¦æˆªå™¨)ã€‚
    *   è‡ªåŠ¨æ‹¦æˆª Header ä¸­çš„ `X-User-Id` å¹¶å­˜å…¥ `UserContext` (ThreadLocal)ã€‚
    *   ä¸šåŠ¡ä»£ç å¯é€šè¿‡ `UserContext.getUserId()` éšæ—¶è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ã€‚

## 4. å…³é”®é…ç½®å¤‡å¿˜

### 4.1 å¯åŠ¨å‚æ•° (VM Options)
*æ‰€æœ‰æœåŠ¡å‡éœ€é…ç½® SkyWalking Agentï¼ŒGateway éœ€é¢å¤–æ ‡è®°ç±»å‹ï¼ŒProvider 8082 éœ€è¦†ç›–ç«¯å£ã€‚*

*   **API Gateway (9000)**:
    
    ```text
    -javaagent:E:\Works\personal-api-gateway\apache-skywalking-java-agent-9.3.0\skywalking-agent\skywalking-agent.jar -Dskywalking.agent.service_name=api-gateway -Dskywalking.collector.backend_service=127.0.0.1:11800 -Dcsp.sentinel.app.type=1
    ```
*   **Provider (8081)**:
    
    ```text
    -javaagent:E:\Works\personal-api-gateway\apache-skywalking-java-agent-9.3.0\skywalking-agent\skywalking-agent.jar -Dskywalking.agent.service_name=service-provider -Dskywalking.collector.backend_service=127.0.0.1:11800 -Dskywalking.plugin.nacos.enabled=false
    ```
*   **Provider (8082)**:
    ```text
    -javaagent:E:\Works\personal-api-gateway\apache-skywalking-java-agent-9.3.0\skywalking-agent\skywalking-agent.jar -Dskywalking.agent.service_name=service-provider -Dskywalking.collector.backend_service=127.0.0.1:11800 -Dskywalking.plugin.nacos.enabled=false -Dserver.port=8082
    ```

* **Consumer (8083)**:

  ```text
  -javaagent:E:\Works\personal-api-gateway\apache-skywalking-java-agent-9.3.0\skywalking-agent\skywalking-agent.jar -Dskywalking.agent.service_name=service-consumer -Dskywalking.collector.backend_service=127.0.0.1:11800 -Dskywalking.plugin.nacos.enabled=false
  ```

  

### 4.2 è¿ç»´è„šæœ¬

*   å·²ç¼–å†™ Windows `start-all.bat` è„šæœ¬ï¼Œä¸€é”®å¯åŠ¨ Nacosã€Sentinel Dashboardã€SkyWalking (OAP + UI)ã€‚

## 5. å¾…åŠäº‹é¡¹ (Next Steps)
*   [ ] **Feign ä»¤ç‰Œä¸­ç»§**ï¼šå®ç° `RequestInterceptor`ï¼Œè§£å†³ Consumer è°ƒç”¨ Provider æ—¶ Token/UserID ä¸¢å¤±çš„é—®é¢˜ï¼ˆå…¨é“¾è·¯èº«ä»½é—­ç¯ï¼‰ã€‚
*   [ ] **å‰ç«¯å¯è§†åŒ–**ï¼šæ­å»ºç®€æ˜“ç®¡ç†åå°ã€‚
