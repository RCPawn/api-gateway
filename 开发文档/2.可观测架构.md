## **第二阶段：可观测性架构**

### 🛠️ 准备工作：SkyWalking 架构简介

SkyWalking 不需要你在 pom.xml 里加一堆繁琐的依赖，它采用的是 **“非侵入式” (Agent)** 方案。

- **OAP Server**: 服务端，负责收集数据、分析、存储（类似 Nacos Server）。
- **UI**: 网页控制台（类似 Nacos Console）。
- **Agent (探针)**: 一个 .jar 包，启动 Java 应用时挂载上去，它会自动当“间谍”收集数据发送给 OAP。

------



### 📝 实施步骤

#### 第一步：下载与启动 SkyWalking Server

1. **下载**：
   - 去 Apache SkyWalking 官网下载：[Downloads | Apache SkyWalking](https://www.google.com/url?sa=E&q=https%3A%2F%2Fskywalking.apache.org%2Fdownloads%2F)
   - 找到 **SkyWalking APM** (注意不是 Java Agent，是主程序)。
   - 建议下载 **9.x 或 10.x** 版本（文件名类似 apache-skywalking-apm-10.0.0.tar.gz）。
   - *注意：SkyWalking 默认需要 JDK 11+，你用 JDK 17 没问题。*
2. **解压**：
   - 解压到一个路径（比如 D:\skywalking），不要有中文或空格。
3. **端口防冲突检查 (关键)**：
   - SkyWalking UI 默认占用 **8080** 端口。
   - **检查**：如果你电脑上还有别的服务（比如 Tomcat、Jenkins、或者你自己的微服务）占用了 8080，请修改 webapp/webapp.yml 里的 server.port，改为 8088 之类的。
   - *如果你确定 8080 没人在用，可以不改。*
4. **启动**：
   - 进入 bin 目录。
   - 双击 startup.bat (Windows)。
   - 它会弹出两个黑框框（一个是 Collector 后端，一个是 Web UI 前端），**不要关闭它们**。
5. **验证**：
   - 访问浏览器：http://localhost:8088。
   - 你应该能看到一个蓝色的、非常科幻的 SkyWalking 登录/仪表盘页面（默认不用密码）。

------



#### 第二步：准备 Java Agent (探针)

1. **下载 Agent**：
   - 回到官网下载页，找到 **Java Agent**。
   - 下载 apache-skywalking-java-agent-9.x.x.tgz。
2. **解压**：
   - 解压到一个固定目录，比如 D:\skywalking-agent。
   - **核心文件**是里面的 skywalking-agent.jar。
3. **修改配置 (可选)**：
   - 打开 config/agent.config。
   - 确认 collector.backend_service 是 127.0.0.1:11800（默认就是这个，不用动）。

------



#### 第三步：IDEA 集成 (给微服务挂载探针)

我们需要给 **Gateway**、**Consumer**、**Provider** 这三个服务都挂上探针。
配置方法是一样的，只是 service_name 不同。

**以 API Gateway 为例：**

1. 在 IDEA 顶部工具栏，点击启动配置的下拉框 -> **Edit Configurations**。
2. 选中 ApiGatewayApplication。
3. 找到 **VM Options** (如果没有显示，按 Alt+V 或点击 "Modify options" -> "Add VM options")。
4. **粘贴以下参数 (注意修改路径)**：

```bash
# api-gateway 完整配置：
-javaagent:E:\Works\personal-api-gateway\apache-skywalking-java-agent-9.3.0\skywalking-agent\skywalking-agent.jar -Dskywalking.agent.service_name=api-gateway -Dskywalking.collector.backend_service=127.0.0.1:11800 -Dcsp.sentinel.app.type=1

# Service Provider (默认 8081)
-javaagent:E:\Works\personal-api-gateway\apache-skywalking-java-agent-9.3.0\skywalking-agent\skywalking-agent.jar -Dskywalking.agent.service_name=service-provider -Dskywalking.collector.backend_service=127.0.0.1:11800 -Dskywalking.plugin.nacos.enabled=false

# Service Provider (副本 8082)
-javaagent:E:\Works\personal-api-gateway\apache-skywalking-java-agent-9.3.0\skywalking-agent\skywalking-agent.jar -Dskywalking.agent.service_name=service-provider -Dskywalking.collector.backend_service=127.0.0.1:11800 -Dskywalking.plugin.nacos.enabled=false -Dserver.port=8082

# Service Consumer (8083)
-javaagent:E:\Works\personal-api-gateway\apache-skywalking-java-agent-9.3.0\skywalking-agent\skywalking-agent.jar -Dskywalking.agent.service_name=service-consumer -Dskywalking.collector.backend_service=127.0.0.1:11800 -Dskywalking.plugin.nacos.enabled=false
```

**重复此步骤，给另外两个服务也加上，记得改名字：**

- **Consumer**: -Dskywalking.agent.service_name=service-consumer
- **Provider**: -Dskywalking.agent.service_name=service-provider

------



#### 第四步：见证奇迹

1. **重启所有服务**：
   - Gateway (9000)
   - Consumer (你定义的端口)
   - Provider (8081)
   - *注意：观察启动日志，开头应该会出现 SkyWalking Agent ... started 的字样，说明挂载成功。*
2. **制造流量**：
   - 这步很关键！SkyWalking 是懒加载的，没流量就没有数据。
   - 疯狂访问你的网关接口：
     - http://localhost:9000/consumer/test?token=123 (触发 Gateway -> Consumer -> Provider 的完整链路)
     - 多刷几次，刷个十几二十次。
3. **查看控制台**：
   - 回到浏览器 http://localhost:8088 (SkyWalking UI)。
   - 点击右上角的 **"Auto Refresh" (自动刷新)**。
4. **你将看到**：
   - **仪表盘 (General Service)**：你会看到 QPS 曲线起来了。
   - **拓扑图 (Topology)**：(最帅的功能) 点击顶部菜单的 **Topology**。
     - 你会看到一张图：User -> api-gateway -> service-consumer -> service-provider。
     - 它们之间有连线，线上会显示实时的延迟（ms）。
   - **追踪 (Trace)**：点击顶部菜单的 **Trace**。
     - 你可以看到每一次请求的详细“瀑布流”。
     - 点开一条请求，它会告诉你：网关耗时 2ms，Consumer 处理耗时 50ms，其中 Feign 调用 Provider 耗时 45ms。

------



## 核心复盘与防坑指南：

### 🏆 核心成就

1. **上帝视角**：成功点亮了 SkyWalking 拓扑图，清晰看到了 User -> Gateway -> Consumer -> Provider 的完整调用链路。
2. **非侵入式接入**：没有修改一行 Java 业务代码，仅通过挂载 Agent (-javaagent) 就实现了监控。
3. **问题定位能力**：学会了通过“红色节点”和“Trace 链路”判断是网关挂了、服务没注册、还是接口响应慢。

------



### 📝 关键配置清单 (抄作业用)

#### 1. 启动参数 (VM Options)

所有服务（Gateway/Consumer/Provider）都需要加，只是名字不同：

```
-javaagent:你的路径\skywalking-agent.jar -Dskywalking.agent.service_name=你的服务名 -Dskywalking.collector.backend_service=127.0.0.1:11800
  
```

- **注意**：路径必须精确到 .jar，参数间用空格隔开。

#### 2. 服务注册 (Nacos)

**Consumer 必须注册到 Nacos**，否则网关报 **503**。

```
spring:
  application:
    name: service-consumer # 必须有名字
  cloud:
    nacos:
      discovery:
        server-addr: 127.0.0.1:8848 # 必须配地址
  
```



### 💣 错题本 (排查思路速查)

| 现象                               | 核心原因                                                     | 解决方案                                                     |
| ---------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| **网关报 503 Service Unavailable** | 1. Consumer 没注册到 Nacos (空号)<br>2. SkyWalking 插件把网关搞崩了 | 1. 检查 Consumer 的 YML 配置，重启并在 Nacos 确认存活。<br>2. 删除 agent/plugins 下新加的 jar 包试试。 |
| **SkyWalking 页面一直 Loading**    | OAP 后端没启动成功                                           | 检查 11800/12800 端口，删除 skywalking/data 目录清理脏数据后重启。 |
| **服务列表里没有 Consumer**        | Agent 未挂载或名字冲突                                       | 检查 VM Options 是否漏了 -javaagent:，确认 service_name 没写错。 |
| **Gateway 数据为空**               | 缺少 WebFlux 插件                                            | 从 optional-plugins 搬运 WebFlux 相关插件到 plugins。        |
| **拓扑图是红色的**                 | 有请求失败                                                   | 正常现象。只要修好了 bug，后续成功请求多了，颜色会自动变蓝。 |
| **图表一片空白**                   | 懒加载机制                                                   | SkyWalking 不存历史数据（内存模式），**必须疯狂刷新接口制造流量**才能看到图。 |


