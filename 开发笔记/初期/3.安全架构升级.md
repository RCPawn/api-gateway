### ğŸ›¡ï¸ ç¬¬ä¸‰é˜¶æ®µï¼šå®‰å…¨æ¶æ„å‡çº§ (JWT + é€šç”¨æ¨¡å—)

æˆ‘ä»¬ç°åœ¨çš„ç›®æ ‡ï¼š

1. **åºŸé™¤** token=123 è¿™ç§ç©å…·é€»è¾‘ã€‚
2. **å®ç°** åªæœ‰æºå¸¦åˆæ³• **JWT ä»¤ç‰Œ** çš„è¯·æ±‚æ‰èƒ½é€šè¿‡ç½‘å…³ã€‚
3. **é€ä¼ ** ç½‘å…³è§£æå‡º UserIDï¼Œä¼ ç»™åç«¯çš„ Consumer/Providerï¼Œè®©åç«¯çŸ¥é“â€œå½“å‰ç”¨æˆ·æ˜¯è°â€ã€‚

ä¸ºäº†ä¼˜é›…åœ°å®ç°ä»£ç å¤ç”¨ï¼ˆJWT å·¥å…·ç±» Gateway è¦ç”¨ï¼ŒAuth æœåŠ¡ä¹Ÿè¦ç”¨ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆè¿›è¡Œä¸€æ¬¡ **å¾®å°çš„æ¶æ„é‡æ„**ã€‚

------



### ğŸ› ï¸ æ­¥éª¤ä¸€ï¼šåˆ›å»ºé€šç”¨æ¨¡å— (service-common)

æˆ‘ä»¬ä¸èƒ½æŠŠ JwtUtil ä»£ç åœ¨æ¯ä¸ªæœåŠ¡é‡Œå¤åˆ¶ç²˜è´´ä¸€éï¼Œé‚£å¤ª Low äº†ã€‚

1. **æ–°å»º Module**ï¼š

   - åœ¨çˆ¶å·¥ç¨‹ä¸‹æ–°å»ºä¸€ä¸ªæ¨¡å—ï¼Œå‘½åä¸º service-commonã€‚
   - **ä¸éœ€è¦**é€‰ Spring Boot ä¾èµ–ï¼ˆå®ƒåªæ˜¯ä¸ªæ™®é€šçš„ Jar åŒ…å·¥å…·åº“ï¼‰ã€‚

2. **æ·»åŠ ä¾èµ– (pom.xml)**ï¼š
   åœ¨ service-common çš„ pom.xml é‡Œæ”¾å…¥ JWT å’Œå¸¸ç”¨å·¥å…·åŒ…ï¼š

   

   ```xml
   <dependencies>
       <!-- JWT æ ¸å¿ƒåº“ -->
       <dependency>
           <groupId>io.jsonwebtoken</groupId>
           <artifactId>jjwt</artifactId>
           <version>0.9.1</version>
       </dependency>
       <!-- å·¥å…·ç±» (å¦‚ StringUtils) -->
       <dependency>
           <groupId>org.apache.commons</groupId>
           <artifactId>commons-lang3</artifactId>
       </dependency>
       <!-- Lombok -->
       <dependency>
           <groupId>org.projectlombok</groupId>
           <artifactId>lombok</artifactId>
           <optional>true</optional>
       </dependency>
       
       <!-- è§£å†³ JDK 11+ ä½¿ç”¨ jjwt æŠ¥é”™çš„é—®é¢˜ (å¿…é¡»åŠ ) -->
       <dependency>
           <groupId>javax.xml.bind</groupId>
           <artifactId>jaxb-api</artifactId>
           <version>2.3.1</version>
       </dependency>
   </dependencies>
     
   ```

3. **ç¼–å†™ JWT å·¥å…·ç±»**ï¼š
   åœ¨ com.rcpawn.common.util åŒ…ä¸‹æ–°å»º JwtUtil.javaã€‚
   *(è¿™æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ç”Ÿäº§çº§å·¥å…·ç±»ï¼Œç›´æ¥å¤åˆ¶å³å¯)*

   

   ```java
   package com.rcpawn.common.util;
   
   import io.jsonwebtoken.Claims;
   import io.jsonwebtoken.Jwts;
   import io.jsonwebtoken.SignatureAlgorithm;
   import java.util.Date;
   import java.util.HashMap;
   import java.util.Map;
   
   public class JwtUtil {
       // ç§˜é’¥ (ç”Ÿäº§ç¯å¢ƒåº”è¯¥å†™åœ¨é…ç½®æ–‡ä»¶é‡Œ)
       private static final String SECRET_KEY = "MySecretKey_rcpawn_gateway_demo_2026"; 
       // è¿‡æœŸæ—¶é—´ (24å°æ—¶)
       private static final long EXPIRATION_TIME = 86400000L; 
   
       // 1. ç”Ÿæˆ Token
       public static String generateToken(String userId, String username) {
           Map<String, Object> claims = new HashMap<>();
           claims.put("username", username);
           return Jwts.builder()
                   .setClaims(claims)
                   .setSubject(userId) // æŠŠ UserID å­˜è¿› Subject
                   .setIssuedAt(new Date())
                   .setExpiration(new Date(System.currentTimeMillis() + EXPIRATION_TIME))
                   .signWith(SignatureAlgorithm.HS512, SECRET_KEY)
                   .compact();
       }
   
       // 2. è§£æ Token è·å– Claims
       public static Claims parseToken(String token) {
           try {
               return Jwts.parser()
                       .setSigningKey(SECRET_KEY)
                       .parseClaimsJws(token)
                       .getBody();
           } catch (Exception e) {
               return null; // è§£æå¤±è´¥ï¼ˆè¿‡æœŸæˆ–ç¯¡æ”¹ï¼‰
           }
       }
   
       // 3. æ ¡éªŒå¹¶è·å– UserID
       public static String getUserId(String token) {
           Claims claims = parseToken(token);
           return claims != null ? claims.getSubject() : null;
       }
   }
     
   ```

------



### ğŸ”— æ­¥éª¤äºŒï¼šè®©ç½‘å…³å¼•ç”¨é€šç”¨æ¨¡å—

ç°åœ¨ JwtUtil å†™å¥½äº†ï¼Œç½‘å…³éœ€è¦ç”¨åˆ°å®ƒã€‚

1. æ‰“å¼€ **api-gateway** çš„ pom.xmlã€‚

2. **æ·»åŠ ä¾èµ–**ï¼š

   

   ```xml
   <dependency>
       <groupId>com.rcpawn</groupId>
       <artifactId>service-common</artifactId>
       <version>0.0.1-SNAPSHOT</version>
   </dependency>
     
   ```

3. **åˆ·æ–° Maven**ã€‚

------



### ğŸ‘®â€â™‚ï¸ æ­¥éª¤ä¸‰ï¼šæ”¹é€ ç½‘å…³è¿‡æ»¤å™¨ (AuthGlobalFilter)

ç°åœ¨æˆ‘ä»¬è¦æŠŠä¹‹å‰é‚£ä¸ªç®€é™‹çš„ token=123 é€»è¾‘åˆ æ‰ï¼Œæ¢æˆ JWT æ ¡éªŒã€‚

ä¿®æ”¹ api-gateway é¡¹ç›®ä¸­çš„ AuthGlobalFilter.javaï¼š

```java
package com.rcpawn.gateway.filter;

import com.rcpawn.common.util.JwtUtil; // å¼•å…¥åˆšæ‰å†™çš„å·¥å…·ç±»
import org.springframework.cloud.gateway.filter.GatewayFilterChain;
import org.springframework.cloud.gateway.filter.GlobalFilter;
import org.springframework.core.Ordered;
import org.springframework.http.HttpStatus;
import org.springframework.http.server.reactive.ServerHttpRequest;
import org.springframework.http.server.reactive.ServerHttpResponse;
import org.springframework.stereotype.Component;
import org.springframework.web.server.ServerWebExchange;
import reactor.core.publisher.Mono;

@Component
public class AuthGlobalFilter implements GlobalFilter, Ordered {

    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        ServerHttpRequest request = exchange.getRequest();
        String path = request.getURI().getPath();

        // 1. ç™½åå•æ”¾è¡Œ (æ¯”å¦‚ç™»å½•æ¥å£ã€æ³¨å†Œæ¥å£)
        // å‡è®¾æˆ‘ä»¬è¿˜æ²¡å†™ç™»å½•æ¥å£ï¼Œå…ˆç•™ä¸ªå£å­ï¼Œä¸ç„¶ä½ æ€ä¹ˆè·å– Token å‘¢ï¼Ÿ
        if (path.contains("/auth/login") || path.contains("/doc.html")) {
            return chain.filter(exchange);
        }

        // 2. è·å– Token (é€šå¸¸æ”¾åœ¨ Header çš„ Authorization å­—æ®µï¼Œæˆ–è€… url å‚æ•°)
        // è¿™é‡Œä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œæˆ‘ä»¬å…ˆä» Query Param é‡Œå–ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®ç”¨ Header
        String token = request.getQueryParams().getFirst("token");
        
        // å¦‚æœ url æ²¡å¸¦ï¼Œè¯•ç€ä» Header å–
        if (token == null) {
            String headerAuth = request.getHeaders().getFirst("Authorization");
            if (headerAuth != null && headerAuth.startsWith("Bearer ")) {
                token = headerAuth.substring(7);
            }
        }

        // 3. æ ¡éªŒ Token
        String userId = null;
        if (token != null) {
            userId = JwtUtil.getUserId(token); // ä½¿ç”¨å·¥å…·ç±»è§£æ
        }

        // 4. æ ¡éªŒå¤±è´¥ -> 401 Unauthorized
        if (userId == null) {
            ServerHttpResponse response = exchange.getResponse();
            response.setStatusCode(HttpStatus.UNAUTHORIZED);
            return response.setComplete();
        }

        // 5. ã€å…³é”®ã€‘Token åˆæ³•ï¼ŒæŠŠ UserID ä¼ ç»™ä¸‹æ¸¸æœåŠ¡
        // è¿™æ · Consumer/Provider å°±èƒ½çŸ¥é“æ˜¯è°åœ¨è®¿é—®äº†
        ServerHttpRequest newRequest = request.mutate()
                .header("X-User-Id", userId)
                .build();

        return chain.filter(exchange.mutate().request(newRequest).build());
    }

    @Override
    public int getOrder() {
        return 0;
    }
}
  
```

------



### ğŸ§ª æ­¥éª¤å››ï¼šç”Ÿæˆä¸€ä¸ªæµ‹è¯• Token å¹¶éªŒè¯

å› ä¸ºæˆ‘ä»¬è¿˜æ²¡å†™â€œç™»å½•æœåŠ¡â€ï¼ˆé‚£æ˜¯ä¸‹ä¸€æ­¥çš„äº‹ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆæ‰‹åŠ¨ç”Ÿæˆä¸€ä¸ªåˆæ³•çš„ JWT Token æ¥æµ‹è¯•ç½‘å…³æ˜¯å¦ç”Ÿæ•ˆã€‚

1. **åˆ›å»ºä¸€ä¸ªæµ‹è¯•ç±»**ï¼š
   åœ¨ service-common æ¨¡å—é‡Œï¼Œéšä¾¿å†™ä¸ª main æ–¹æ³•ï¼š

   

   ```java
   public class TestJwt {
       public static void main(String[] args) {
           // æ¨¡æ‹Ÿç»™ç”¨æˆ· ID=888, Name=Admin ç”Ÿæˆä»¤ç‰Œ
           String token = JwtUtil.generateToken("888", "Admin");
           System.out.println("è¯·å¤åˆ¶è¿™ä¸ª Token å»æµ‹è¯•:");
           System.out.println(token);
       }
   }
     
   ```

2. **è¿è¡Œ** è¿™ä¸ª main æ–¹æ³•ï¼Œæ§åˆ¶å°ä¼šæ‰“å°å‡ºä¸€é•¿ä¸²å­—ç¬¦ï¼ˆæ¯”å¦‚ eyJhbGciOi...ï¼‰ã€‚**å¤åˆ¶å®ƒï¼**

3. **é‡å¯ api-gateway**ã€‚

4. **æµ‹è¯•æ‹¦æˆª**ï¼š

   - è®¿é—®ï¼šhttp://localhost:9000/consumer/test (ä¸å¸¦ Token) -> **401 Unauthorized** (æˆåŠŸè¢«æ‹¦ï¼)ã€‚
   - è®¿é—®ï¼šhttp://localhost:9000/consumer/test?token=123 (å¸¦å‡ Token) -> **401 Unauthorized** (æˆåŠŸè¢«æ‹¦ï¼)ã€‚

5. **æµ‹è¯•æ”¾è¡Œ**ï¼š

   - è®¿é—®ï¼šhttp://localhost:9000/consumer/test?token=ä½ åˆšæ‰ç”Ÿæˆçš„é•¿å­—ç¬¦ä¸²ã€‚
   - **é¢„æœŸ**ï¼š**æˆåŠŸè¿”å›æ•°æ®ï¼**

------





### è®©å¾®æœåŠ¡çœŸæ­£æ‹¥æœ‰â€œèº«ä»½â€ï¼š

1. **ä¸Šä¸‹æ–‡ (UserContext)**ï¼šè®©åç«¯æœåŠ¡èƒ½éšæ—¶éšåœ°çŸ¥é“â€œå½“å‰ç”¨æˆ·æ˜¯è°â€ã€‚
2. **æ‹¦æˆªå™¨ (Interceptor)**ï¼šè‡ªåŠ¨ä» HTTP Header é‡ŒæŠ“å–ç½‘å…³ä¼ è¿‡æ¥çš„ X-User-Idã€‚
3. **ç™»å½•æ¥å£ (Login API)**ï¼šæä¾›ä¸€ä¸ªæ­£ç»çš„æ¥å£æ¥è·å– Tokenã€‚

------



### ğŸ› ï¸ ç¬¬ä¸€æ­¥ï¼šå®Œå–„é€šç”¨æ¨¡å— (service-common)

æˆ‘ä»¬éœ€è¦åœ¨ service-common é‡ŒåŠ ç‚¹ä¸œè¥¿ï¼Œè¿™æ ·æ‰€æœ‰çš„å¾®æœåŠ¡éƒ½èƒ½å¤ç”¨è¿™äº›é€»è¾‘ã€‚

#### 1. æ·»åŠ  Web ä¾èµ–

å› ä¸ºæˆ‘ä»¬è¦å†™æ‹¦æˆªå™¨ï¼ˆæ¶‰åŠåˆ° HttpServletRequestï¼‰ï¼Œæ‰€ä»¥ service-common éœ€è¦è®¤è¯† Web ç›¸å…³çš„ç±»ã€‚

ä¿®æ”¹ service-common çš„ pom.xmlï¼Œæ·»åŠ ï¼š

```xml
<!-- ä¸ºäº†ä½¿ç”¨ HttpServletRequest å’Œ Spring MVC æ‹¦æˆªå™¨ -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
    <optional>true</optional> <!-- optionalè¡¨ç¤ºè°å¼•ç”¨æˆ‘ï¼Œè°æ‰éœ€è¦è¿™ä¸ª -->
</dependency>
```

#### 2. åˆ›å»ºç”¨æˆ·ä¸Šä¸‹æ–‡ (UserContext.java)

åœ¨ com.rcpawn.common.util åŒ…ä¸‹æ–°å»º UserContext.javaã€‚
è¿™æ˜¯ä¸€ä¸ªåŸºäº ThreadLocal çš„å·¥å…·ï¼Œç”¨äºåœ¨å½“å‰çº¿ç¨‹ä¸­å­˜å‚¨ç”¨æˆ·ä¿¡æ¯ã€‚

```java
package com.rcpawn.common.util;

public class UserContext {
    // ThreadLocal ä¿è¯çº¿ç¨‹éš”ç¦»ï¼Œæ¯ä¸ªè¯·æ±‚äº’ä¸å¹²æ‰°
    private static final ThreadLocal<String> userHolder = new ThreadLocal<>();

    public static void setUserId(String userId) {
        userHolder.set(userId);
    }

    public static String getUserId() {
        return userHolder.get();
    }

    // åŠ¡å¿…è®°å¾—æ¸…é™¤ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ï¼ˆå°¤å…¶æ˜¯åœ¨çº¿ç¨‹æ± ç¯å¢ƒä¸‹ï¼‰
    public static void remove() {
        userHolder.remove();
    }
}
  
```

#### 3. ç¼–å†™é€šç”¨æ‹¦æˆªå™¨ (UserInfoInterceptor.java)

è¿™ä¸ªæ‹¦æˆªå™¨çš„ä½œç”¨æ˜¯ï¼š**â€œåªè¦æœ‰è¯·æ±‚è¿›æ¥ï¼Œå°±è‡ªåŠ¨çœ‹çœ‹ Header é‡Œæœ‰æ²¡æœ‰ç½‘å…³ä¼ æ¥çš„ IDï¼Œæœ‰å°±å­˜åˆ° Context é‡Œã€‚â€**

åœ¨ com.rcpawn.common.interceptor (æ–°å»ºåŒ…) ä¸‹åˆ›å»ºï¼š

```java
package com.rcpawn.common.interceptor;

import com.rcpawn.common.util.UserContext;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.util.StringUtils;
import org.springframework.web.servlet.HandlerInterceptor;

public class UserInfoInterceptor implements HandlerInterceptor {

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
        // 1. ä» Header ä¸­è·å–ç½‘å…³é€ä¼ çš„ User-Id
        String userId = request.getHeader("X-User-Id");
        
        // 2. å¦‚æœä¸ä¸ºç©ºï¼Œå­˜å…¥ ThreadLocal
        if (StringUtils.hasText(userId)) {
            UserContext.setUserId(userId);
        }
        
        // 3. æ”¾è¡Œ
        return true;
    }

    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) {
        // 4. è¯·æ±‚ç»“æŸï¼Œå¿…é¡»æ¸…ç† ThreadLocalï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
        UserContext.remove();
    }
}
  
```

#### âš ï¸ å…³é”®åŠ¨ä½œï¼šé‡æ–° Install

å› ä¸ºä½ æ”¹äº† service-commonï¼Œå¿…é¡»è®© Maven é‡æ–°æ‰“åŒ…ã€‚

- **æ“ä½œ**ï¼šIDEA å³ä¾§ Maven -> çˆ¶å·¥ç¨‹ -> Lifecycle -> **clean** -> **install**ã€‚

------



### ğŸ”‘ ç¬¬äºŒæ­¥ï¼šå®ç°ç™»å½•æ¥å£ (service-consumer)

æˆ‘ä»¬å°†æŠŠç™»å½•åŠŸèƒ½æš‚æ—¶æ”¾åœ¨ service-consumer é‡Œï¼ˆæŠŠå®ƒå½“åšç”¨æˆ·ä¸­å¿ƒï¼‰ã€‚

#### 1. ç¼–å†™ AuthController

åœ¨ service-consumer é¡¹ç›®çš„ com.rcpawn.controller åŒ…ä¸‹æ–°å»º AuthController.javaï¼š

```java
package com.rcpawn.controller;

import com.rcpawn.common.util.JwtUtil;
import org.springframework.web.bind.annotation.*;

import java.util.HashMap;
import java.util.Map;

@RestController
@RequestMapping("/consumer/auth")
public class AuthController {

    @PostMapping("/login")
    public Map<String, Object> login(@RequestParam String username, @RequestParam String password) {
        Map<String, Object> result = new HashMap<>();
        
        // 1. æ¨¡æ‹Ÿæ•°æ®åº“æ ¡éªŒ (çœŸå®åœºæ™¯è¯·æŸ¥æ•°æ®åº“)
        if ("admin".equals(username) && "123456".equals(password)) {
            // 2. æ ¡éªŒé€šè¿‡ï¼Œç”Ÿæˆ Token (å‡è®¾ UserID æ˜¯ 8888)
            String token = JwtUtil.generateToken("8888", username);
            
            result.put("code", 200);
            result.put("msg", "ç™»å½•æˆåŠŸ");
            result.put("token", token);
        } else {
            result.put("code", 401);
            result.put("msg", "è´¦å·æˆ–å¯†ç é”™è¯¯");
        }
        return result;
    }
}
  
```

------



### ğŸ”Œ ç¬¬ä¸‰æ­¥ï¼šé…ç½®æ‹¦æˆªå™¨ç”Ÿæ•ˆ (service-consumer)

è™½ç„¶æˆ‘ä»¬åœ¨ common é‡Œå†™äº†æ‹¦æˆªå™¨ç±»ï¼Œä½† Spring Boot ä¸ä¼šè‡ªåŠ¨åŠ è½½å®ƒï¼Œæˆ‘ä»¬éœ€è¦**æ³¨å†Œ**å®ƒã€‚

åœ¨ service-consumer é¡¹ç›®ä¸­ï¼Œæ–°å»ºåŒ… com.rcpawn.configï¼Œæ–°å»ºç±» WebMvcConfig.javaï¼š

```java
package com.rcpawn.config;

import com.rcpawn.common.interceptor.UserInfoInterceptor;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.InterceptorRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class WebMvcConfig implements WebMvcConfigurer {

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        // æ³¨å†Œæˆ‘ä»¬å†™çš„æ‹¦æˆªå™¨ï¼Œæ‹¦æˆªæ‰€æœ‰è·¯å¾„
        registry.addInterceptor(new UserInfoInterceptor())
                .addPathPatterns("/**");
    }
}
  
```

------



### ğŸ§ª ç¬¬å››æ­¥ï¼šä¿®æ”¹ä¸šåŠ¡ä»£ç éªŒè¯æ•ˆæœ

æˆ‘ä»¬ä¿®æ”¹ ConsumerControllerï¼Œè®©å®ƒæ‰“å°å‡ºå½“å‰æ˜¯è°åœ¨è®¿é—®ã€‚

ä¿®æ”¹ ConsumerController.javaï¼š

```java
@GetMapping("/test")
public String test() {
    // âœ¨ ä¸€è¡Œä»£ç è·å–å½“å‰ç”¨æˆ· ID
    String currentUserId = UserContext.getUserId();
    
    System.out.println("å½“å‰ç™»å½•çš„ç”¨æˆ·IDæ˜¯: " + currentUserId);
    
    String result = providerClient.callHello();
    return "æˆ‘æ˜¯æ¶ˆè´¹è€…(User=" + currentUserId + ")ï¼Œè¿œç¨‹è¿”å›ï¼š" + result;
}
  
```

------



### ğŸš€ æœ€ç»ˆå…¨é“¾è·¯æµ‹è¯•

#### 1. å‡†å¤‡å·¥ä½œ

- ç¡®ä¿ service-common å·²ç» **Install** æˆåŠŸã€‚
- é‡å¯ api-gatewayã€‚
- é‡å¯ service-consumerã€‚
- ç¡®ä¿ service-provider ä¹Ÿåœ¨è¿è¡Œã€‚

#### 2. åœºæ™¯ä¸€ï¼šå°è¯•ç™»å½• (è·å–é’¥åŒ™)

- æ‰“å¼€æµè§ˆå™¨æˆ– Postmanã€‚
- **æ³¨æ„**ï¼šå› ä¸ºç™»å½•æ¥å£åœ¨ consumer é‡Œï¼Œæˆ‘ä»¬è¦èµ°ç½‘å…³è®¿é—®å®ƒã€‚
- **URL**: http://localhost:9000/consumer/auth/login?username=admin&password=123456 (æ³¨æ„è·¯å¾„åŒ…å« /consumer)
- **æ–¹æ³•**: POST (æµè§ˆå™¨åœ°å€æ é»˜è®¤æ˜¯ GETï¼Œå»ºè®®ç”¨ Postmanï¼Œæˆ–è€…ä¸´æ—¶æŠŠ Controller æ”¹æˆ GetMapping ä¹Ÿè¡Œ)
- **å‚æ•°**: username=admin, password=123456
- **ç½‘å…³ååº”**ï¼šä½ çš„ AuthGlobalFilter é‡Œå†™äº† if (path.contains("/auth/login")) æ”¾è¡Œï¼Œæ‰€ä»¥è¿™ä¸ªè¯·æ±‚ä¸ä¼šè¢«æ‹¦ã€‚
- **ç»“æœ**ï¼šä½ åº”è¯¥èƒ½æ‹¿åˆ°ä¸€ä¸ª JSONï¼Œé‡Œé¢æœ‰ä¸€ä¸² **Token**ã€‚

#### 3. åœºæ™¯äºŒï¼šè®¿é—®ä¸šåŠ¡ (ä½¿ç”¨é’¥åŒ™)

- å¤åˆ¶åˆšæ‰æ‹¿åˆ°çš„ Tokenã€‚
- è®¿é—®ï¼šhttp://localhost:9000/consumer/test?token=ä½ çš„Tokenã€‚
- **è§‚å¯Ÿæµè§ˆå™¨**ï¼šåº”è¯¥æ˜¾ç¤º æˆ‘æ˜¯æ¶ˆè´¹è€…(User=8888)...ã€‚
- **è§‚å¯Ÿ IDEA æ§åˆ¶å°** (service-consumer çš„æ—¥å¿—)ï¼šåº”è¯¥æ‰“å°å‡º å½“å‰ç™»å½•çš„ç”¨æˆ·IDæ˜¯: 8888ã€‚

------



### ğŸ‰ æ€»ç»“

åˆ°æ­¤ä¸ºæ­¢ï¼Œä½ å·²ç»å®Œæˆäº†ä¸€å¥—**é—­ç¯çš„å¾®æœåŠ¡é‰´æƒä½“ç³»**ï¼š

1. **ç”¨æˆ·** -> **ç½‘å…³** (æ ¡éªŒ Token -> æå– UserID -> æ”¾å…¥ Header)ã€‚
2. **ç½‘å…³** -> **Consumer** (æ‹¦æˆªå™¨æ‹¦æˆª Header -> æ”¾å…¥ ThreadLocal)ã€‚
3. **Consumer ä¸šåŠ¡ä»£ç ** (é€šè¿‡ UserContext.getUserId() éšæ—¶éšåœ°æ‹¿ç”¨æˆ·ä¿¡æ¯)ã€‚

ç°åœ¨ï¼Œä½ çš„ç³»ç»Ÿä¸ä»…â€œå›ºè‹¥é‡‘æ±¤â€ï¼Œè€Œä¸”å†…éƒ¨æ²Ÿé€šâ€œç•…é€šæ— é˜»â€ã€‚
è™½ç„¶è¿˜å·®ä¸€ä¸ª Feign è°ƒç”¨æ—¶çš„ Token ä¼ é€’ï¼ˆè®© Provider ä¹ŸçŸ¥é“æ˜¯è°ï¼‰ï¼Œä½†å¯¹äºç›®å‰çš„é˜¶æ®µï¼Œè¿™å·²ç»æ˜¯éå¸¸å®Œæ•´çš„æˆæœäº†ï¼                              